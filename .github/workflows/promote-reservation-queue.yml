name: Promote Reservation Queue

on:
  schedule:
    # Run every minute (GitHub Actions minimum is 1 minute)
    # The script will call the endpoint every 10 seconds within each run
    - cron: '*/1 * * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  promote-queue:
    runs-on: ubuntu-latest
    timeout-minutes: 1 # Run for 1 minute, calling every 10 seconds
    
    steps:
      - name: Promote Reservation Queue
        run: |
          # Set API endpoint URL (update this if your API URL is different)
          API_URL="${API_URL:-https://taratechapi.fly.dev/api/ecosuite/promote-reservation-queue/}"
          BRAND_ID="ILY79IOQG6"
          OUTLET_ID="74f2e7c0-bc5a-11f0-9935-313b5fd1007a"
          
          # Calculate end time (1 minute from now)
          END_TIME=$(($(date +%s) + 60))
          
          echo "Starting reservation queue promotion..."
          echo "API URL: ${API_URL}"
          echo "Brand ID: ${BRAND_ID}"
          echo "Outlet ID: ${OUTLET_ID}"
          echo "Will run every 10 seconds for 1 minute"
          
          # Loop every 10 seconds until 1 minute has passed
          while [ $(date +%s) -lt $END_TIME ]; do
            echo ""
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] Calling promote reservation queue endpoint..."
            
            # Make the API call
            RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
              "${API_URL}?brandId=${BRAND_ID}&outletId=${OUTLET_ID}" \
              -H "Content-Type: application/json")
            
            HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS" | cut -d: -f2)
            BODY=$(echo "$RESPONSE" | sed '/HTTP_STATUS/d')
            
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "✓ Success: $BODY"
            else
              echo "✗ Error (HTTP $HTTP_STATUS): $BODY"
            fi
            
            # Sleep for 10 seconds
            sleep 10
          done
          
          echo ""
          echo "Completed reservation queue promotion cycle"

